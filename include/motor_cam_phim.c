


void PCA_Timer_init(){
	CCAP0L = CCAP0H = 0;
	PCA_Timer0 = 25000;
	PCA_Timer1 = 25;
	CCAPM0 = 0x49;
	CCAPM1 = 0x49;
	CR=1;
}


void xunggiay(){
	WATCHDOG;
	flip_pulse^=1;
	// over_cur_led = flip_pulse;
	// if(Relay1 && !--relay1_delay_tat){
	// 	Relay1 = 0;
	// 	relay1_delay_tat = 5;
	// } 
	if(phim_mode_doi && phim_mode_giu)phim_mode_doi--;
	if(phim_back_doi && phim_back_giu)phim_back_doi--;
	if(phim_cong_doi && phim_cong_giu)phim_cong_doi--;
	if(!phim_cong_doi)skip_gsm_cmd = 1;
	if(connect) connect--;
	if(total_try_time_out) total_try_time_out--;
	if(mode && mode_wait) mode_wait--;
	if(!gsm_pw && !--gsm_delay_reset){
		gsm_pw = 1;
		gsm_delay_reset = 10;
		gsm_reset=1;
	}
	if(++second>59){
		phut_out = 1;
		second=0;
		if(so_lan_goi_dien && !--delay_cuoc_goi_ke_tiep) so_lan_goi_dien = 0;
		if(++minute>59){
			minute=0;
			if(++hour>23){
				hour=0;
				if(ngay_reset_con_lai)
				ngay_reset_con_lai--;

			}
		}
			
	}
}


u8 __xdata cnt = 20;
u8 __xdata counter_xung_giay=40;
u16 __xdata counter_test_giay=50000;
__bit lcd_update_chop = 0;
void	PCA_Handler (void) __interrupt PCA_VECTOR __using MEM_DONG_HO{
	WATCHDOG;
	if(CCF0){
		CCF0=0;//tat co PCA timer 0
		CCAP0L = PCA_Timer0; //nap vao vi tri timer tiep theo
		CCAP0H = PCA_Timer0 >> 8;
		PCA_Timer0 += 25000; //tang bien nap vao len 25ms
		
		if(phim_mode_xuong && phim_mode_vao) phim_mode_doi = 2;
		phim_mode_giu = phim_mode_xuong && !phim_mode_vao;
		phim_mode_xuong = !phim_mode_cu && !phim_mode_vao;
		phim_mode_nhan = phim_mode_nhan || (!phim_mode_giu && phim_mode_xuong);
		phim_mode_cu = phim_mode_vao;
		
		if(phim_back_xuong && key_in2) phim_back_doi = 6;
		phim_back_giu = phim_back_xuong && !key_in2;
		phim_back_xuong = !phim_back_cu && !key_in2;
		phim_back_nhan = phim_back_nhan || (!phim_back_giu && phim_back_xuong);
		phim_back_cu = key_in2;

		if(phim_cong_xuong && key_in3) phim_cong_doi = 2;
		phim_cong_giu = phim_cong_xuong && !key_in3;
		phim_cong_xuong = !phim_cong_cu && !key_in3;
		phim_cong_nhan = phim_cong_nhan || (!phim_cong_giu && phim_cong_xuong);
		phim_cong_cu = key_in3;

		if(!--cnt){
			lcd_update_chop = 1;
			cnt=10;
			chop=!chop;
		
		}

		if(!--counter_xung_giay){
			counter_xung_giay=40;
			xunggiay();
		}
		
	}
	if(CCF1){
		// u8 i;
		CCF1 = 0;
		CCAP1L = PCA_Timer1;
		CCAP1H = PCA_Timer1>>8;
		PCA_Timer1 +=330;
		// if(!--counter_test_giay){
		// 	over_cur_led = !over_cur_led;
		// 	counter_test_giay = 2000;
		// 	xunggiay();
		// }
		if(rfprocess)return;
		if(cam_che){
			if(!count_low){
				if(rfstatus && count_hi>2 && count_hi<5) {rfdata[rfindex++] = 0; send_gsm_byte('0');}
				if(count_hi>50){rfstop = 1;send_gsm_byte('B');Relay1 = Relay3 = 0; Relay2 = relay2giu;}
			}
			count_low++;count_hi=0;
		}else{
			if(!count_hi){
				if(rfstatus && count_low>2 && count_low<5) {rfdata[rfindex++] = 1;send_gsm_byte('1');}
				else if(count_low>28 && count_low<34){
					if(rfstatus && rfindex==24) {rfprocess = 1;send_gsm_byte('P');}
					else if(rfstop) {rfstatus = 1; rfindex = 0;send_gsm_byte('S');}
					
				}
			}
			count_hi++;count_low=0;
		}
		if(rfindex>24){
			rfindex = 0;
			rfstatus = 0;
		}
	}

}

//11000100111000011011
//00010001
//00000011-00000011-11111100-11111100-11111100-00000011-11111100-11111100-00000011-00000011-00000011-11111100-11111100
//11111100-11111100-00000011-00000011-11111100-00000011-00000011
//
//111111111111111111111111111111100010001011100010001011101110111011100010001000000110011000010111011001100001000101110111011100010
//11111111111111111111111111111100001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000100110011000010111011101110001000101110111011100010
//11111111111111111111111111111100001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010000000010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010000001100110011001100001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111001100000000101110111011100010
//11111111111111111111111111111100000000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110011001100000000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111001100000000101110111011100010
//11111111111111111111111111111100000000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100000000001100110011001110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010000000010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000000110011001100001000101110111011100010
//11111111111111111111111111111100001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100000000101110111011100010
//11111111111111111111111111111100000000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001001100110011000010
//11111111111111111111111111111100000000001100001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001011101110111000000
//11111111111111111111111111111100010000001100000000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001011101110111000100
//11111111111111111111111111111100010001001100000000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001011101110111000000
//11111111111111111111111111111100000000001100000000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001011101110011000000
//11111111111111111111111111111100000000001100001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010000001100110011000010
//11111111111111111111111111111100000000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110011001100000000101110111011100010
//11111111111111111111111111111100001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000100110011000010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100000000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100000000001100110011101100001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001001100110011000010
//11111111111111111111111111111100000000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110011000000111011001110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011100110011001100001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001011101110011000010
//11111111111111111111111111111100000000001100001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110011000010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010000001100110011001100001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100000000101110111011100010
//11111111111111111111111111111100001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100000000000010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001011100110011000010
//11111111111111111111111111111100000000001100001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000010110011100010111011101110001000101110111011100010
//11111111111111111111111111111110001000101110001000101110111011101110001000100010111011100010111011101110001000101110111011100010
//111111111111111111111111111111100010001011100010001011101110111011100010001000101110111000101110111011100010001011101110111000000
//1111111111111111111111111111110000000000110000100010111011101110111000100010001

//0001-0001 0111-0001 0001-0111 0111-0111 0111-0001 0001-0001 0111-0111 0001-0111 0111-0111 0001-0001 0111-0111 0111-0001
// 0    0     1   0  - 0    1  -  1    1 -  1   0  - 0    0  - 1    1  - 0     1 -  1   1  -  0   0  -  1   1  -  1   0
//27-8d-0c
//0010 - 01-11-10-
//0010 3010320123
//0001-0111 3
//0111-0111 0
//0001-0001 1
//0111-0001 2
//S0010 0111 1000 1101 1100 1011S
//S0010 0111 1000 1101 1100 1110S
//0001 000101110001000101110111011101110001000100010111011100010111011101110001000101110111 0111 0001
